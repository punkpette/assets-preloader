(function(h,p){typeof exports=="object"&&typeof module<"u"?module.exports=p(require("events")):typeof define=="function"&&define.amd?define(["events"],p):(h=typeof globalThis<"u"?globalThis:h||self,h.AssetsPreloader=p(h.EventEmitter))})(this,function(h){"use strict";var p=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function _(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var c={exports:{}};(function(o,e){(function(){function t(i){var n=null;if(typeof i!="string")return n;var r=i.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return r&&r.length&&(n=r[1]),n}o.exports&&(e=o.exports=t),e.base64MimeType=t}).call(p)})(c,c.exports);var R=c.exports;const m=_(R);function y(o){return/^(data:\w+\/[a-zA-Z\+\-\.]+;base64,)?([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{4}|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)$/gi.test(o)}function w(o){let e;return y(o)?e=m(o).split("/")[1]:e=o.split(".").pop(),e||null}function C(o){const e=o.split(`
`),t={},i=/([a-zA-Z0-9\-_]+): *(.+)/;let n=null;for(let r=0,l=e.length;r<l;r++)e[r]!==""&&(n=i.exec(e[r]),n&&(t[n[1]]=n[2]));return t}class u{constructor(e){this.mime=null,this.size=null,this.lastModified=null,this.httpHeader=null,e&&this.setFromHTTPHeader(e)}setFromHTTPHeader(e){this.httpHeader=C(e),this.httpHeader["content-length"]&&(this.size=this.httpHeader["content-length"]),this.httpHeader["content-type"]&&(this.mime=this.httpHeader["content-type"]),this.httpHeader["last-modified"]&&(this.lastModified=new Date(this.httpHeader["last-modified"]))}}function x(o){const e=new ArrayBuffer(o.length*2),t=new Uint16Array(e);for(let i=0,n=o.length;i<n;i++)t[i]=o.charCodeAt(i);return e}const P={gif:"image/gif",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",svg:"image/svg+xml",html:"text/html",css:"text/css",csv:"text/csv",xml:"text/xml",mp4:"video/mp4",ogg:"video/ogg",ogv:"video/ogg",webm:"video/webm",wav:"audio/wav",mp3:"audio/mpeg"};function T(o){let e;if(y(o))e=m(o);else{const t=w(o);e=P[t.toLowerCase()]}return e||"application/octet-stream"}class s extends h{constructor(e,t){super(),this.options=t||{},this.options.onComplete&&this.on("complete",this.options.onComplete),this.options.onProgress&&this.on("progress",this.options.onProgress),this.xhr=null,this.content=null,this.url=null,this.loadType=e||s.typeText,this.loadTypeSet=!1,this.fileMeta=null,this._onStateChange=this._onStateChange.bind(this),this._onProgress=this._onProgress.bind(this),this._dispatchProgress=this._dispatchProgress.bind(this),this._dispatchComplete=this._dispatchComplete.bind(this)}canLoadUsingXHR(){return typeof XMLHttpRequest<"u"}canLoadType(e){const t=new XMLHttpRequest;return t.open("GET","someFakeURL",!0),this.checkAndSetType(t,e)}load(e){if(this.url=e,this.canLoadUsingXHR()){if(this.xhr=new XMLHttpRequest,this.xhr.open("GET",e,!0),this.xhr.onreadystatechange=this._onStateChange,this.xhr.onprogress!==void 0&&(this.xhr.onprogress=this._onProgress),this.loadType!==s.typeText){this.checkIfGoodValue()||(console.warn(`Attempting to use incompatible load type ${this.loadType}. Switching it to ${s.typeText}`),this.loadType=s.typeText);try{this.loadTypeSet=this.checkResponseTypeSupport()&&this.checkAndSetType(this.xhr,this.loadType)}catch{this.loadTypeSet=!1}!this.loadTypeSet&&(this.loadType===s.typeBlob||this.loadType===s.typeArraybuffer)&&this.xhr.overrideMimeType("text/plain; charset=x-user-defined")}this.xhr.send()}}stopLoad(){this.xhr.abort()}_dispatchStart(){this.emit("start")}_dispatchProgress(e){this.emit("progress",e)}_dispatchComplete(){this.emit("complete",this.content)}_dispatchError(e){this.emit("error",e)}_onProgress(e){const t=e.loaded||e.position,i=e.total||e.totalSize;i?this._dispatchProgress(t/i):this._dispatchProgress(0)}_onStateChange(){if(this.xhr.readyState>1){let e,t=!1;try{e=this.xhr.status}catch{t=!0}if(e===200)switch(this.xhr.readyState){case 2:this.fileMeta=new u(this.xhr.getAllResponseHeaders()),this._dispatchStart();break;case 3:break;case 4:this._parseContent(),this._dispatchComplete();break}else t||(this.xhr.onreadystatechange=void 0,this._dispatchError(this.xhr.status))}}_parseContent(){if(this.loadTypeSet||this.loadType===s.typeText)this.content=this.xhr.response||this.xhr.responseText;else switch(this.loadType){case s.typeArraybuffer:if(ArrayBuffer)this.content=x(this.xhr.response);else throw new Error("This browser does not support ArrayBuffer");break;case s.typeBlob:case s.typeVideo:case s.typeAudio:if(Blob)this.fileMeta||(this.fileMeta=new u),this.fileMeta.mime===null&&(this.fileMeta.mime=T(this.url)),this.content=new Blob([x(this.xhr.response)],{type:this.fileMeta.mime});else throw new Error("This browser does not support Blob");break;case s.typeJSON:this.content=JSON.parse(this.xhr.response);break;case s.typeDocument:this.content=this.xhr.response;break}}checkIfGoodValue(){return this.loadType===s.typeText||this.loadType===s.typeArraybuffer||this.loadType===s.typeBlob||this.loadType===s.typeJSON||this.loadType===s.typeDocument||this.loadType===s.typeVideo||this.loadType===s.typeAudio}checkResponseTypeSupport(){return this.xhr.responseType!==void 0}checkAndSetType(e,t){return(t===s.typeVideo||t===s.typeAudio)&&(t=s.typeBlob),e.responseType=t,e.responseType===t}}s.typeText="text",s.typeArraybuffer="arraybuffer",s.typeBlob="blob",s.typeJSON="json",s.typeDocument="document",s.typeVideo="video",s.typeAudio="audio";class a extends s{constructor(e){super(s.typeArraybuffer,e),this._imageLoaded=!1}load(e){this.options.xhrImages&&this.canLoadUsingXHR()&&this.canLoadType(this.loadType)&&ArrayBuffer&&(window.URL||window.webkitURL||FileReader)?super.load(e):this._createAndLoadImage(e)}_dispatchProgress(e){super._dispatchProgress(this._imageLoaded?e:e*.9999)}_dispatchComplete(){this._imageLoaded&&super._dispatchComplete()}_onImageLoadComplete(){this._imageLoaded=!0,this._dispatchProgress(1),this._dispatchComplete()}_onImageLoadFail(){this._dispatchError("Image failed to load")}_parseContent(){let e=null,t=null;if(this.fileMeta||(this.fileMeta=new u),(!this.loadTypeSet||this.fileMeta.mime===null)&&(this.fileMeta.mime=T(this.url)),this.xhr.response instanceof ArrayBuffer)e=this.xhr.response;else if(this.xhr.mozResponseArrayBuffer)e=this.xhr.mozResponseArrayBuffer;else throw new Error("Return type for image load unsupported");if(t=new Blob([e],{type:this.fileMeta.mime}),window.URL||window.webkitURL)this._createAndLoadImage((window.URL||window.webkitURL).createObjectURL(t));else if(FileReader){const i=new FileReader;i.onloadend=()=>{(window.URL||window.webkitURL)&&(window.URL||window.webkitURL).revokeObjectURL(t),this._createAndLoadImage(i.result)},i.readAsDataURL(t)}}_createAndLoadImage(e){this.content=new Image,this.content.onload=this._onImageLoadComplete.bind(this),this.content.onerror=this._onImageLoadFail.bind(this),this.content.src=e}}class b extends s{constructor(e){super(s.typeText,e)}}class L extends s{constructor(e){super(s.typeJSON,e)}}class d extends s{constructor(e){super(s.typeVideo,e)}_parseContent(){if(super._parseContent(),window.URL&&window.URL.createObjectURL){const e=window.URL.createObjectURL(this.content);this.content=document.createElement(this.loadType),this.content.src=e}else throw new Error("This browser does not support URL.createObjectURL()")}}class f extends d{constructor(e){super(e),this.loadType=s.typeAudio}}const A={png:a,jpg:a,jpeg:a,webp:a,gif:a,json:L,mp4:d,ogg:d,ogv:d,webm:d,mp3:f,wav:f},S=b;class g extends h{constructor(e){super(),this.initialize(e)}parseOptions(e){return{xhrImages:e.xhrImages||!1,onComplete:typeof e.onComplete=="function"?e.onComplete:void 0,onProgress:typeof e.onProgress=="function"?e.onProgress:void 0,throttle:e.throttle||0}}mergeOptions(e){return{xhrImages:e.xhrImages||this.options.xhrImages,onComplete:typeof e.onComplete=="function"?e.onComplete:this.options.onComplete,onProgress:typeof e.onProgress=="function"?e.onProgress:this.options.onProgress,throttle:e.throttle||this.options.throttle}}initialize(e){if(!(this instanceof g))return new Preloader(e);this.options=this.parseOptions(e),this.options.onComplete&&this.on("complete",this.options.onComplete),this.options.onProgress&&this.on("progress",this.options.onProgress),this.reset(),this.loaders={},this._continueLoadQueue=this._continueLoadQueue.bind(this)}add(e,t){e&&this.addFromLoaderType(e,this._getLoader(e),t)}addImage(e,t){this.addFromLoaderType(e,a,t)}addJSON(e,t){this.addFromLoaderType(e,L,t)}addText(e,t){this.addFromLoaderType(e,b,t)}addVideo(e,t){this.addFromLoaderType(e,d,t)}addAudio(e,t){this.addFromLoaderType(e,f,t)}addFromLoaderType(e,t,i){if(!this.loaders[e])return this.loaders[e]=new t(this.mergeOptions(i||{})),this.urls.push(e),this.loaders[e]}setPercentage(e,t){this.percentageOfLoad[e]=t}load(){if(!this.loading){this._setupPercentages();const e=this.options.throttle||this.urls.length;for(let t=0;t<e;t++)this._continueLoadQueue()}}reset(){this.percTotal=0,this.loadIdx=0,this.urls=[],this.progress=0,this.percentageOfLoad={},this.loading=!1,this.status={}}stopLoad(){if(this.loading)for(let e=0,t=this.urls.length;e<t;e++)this.loaders[this.urls[e]].stopLoad()}get(e){return this.loaders[e]&&this.loaders[e].content}_setupPercentages(){let e=0,t=1,i=0,n=1/this.urls.length;for(let r=0,l=this.urls.length;r<l;r++)this.percentageOfLoad[this.urls[r]]?e+=this.percentageOfLoad[this.urls[r]]:i++;if(i>0){e>1&&(t=1/e,e*=t),n=(1-e)/i;for(let r=0,l=this.urls.length;r<l;r++)this.percentageOfLoad[this.urls[r]]?this.percentageOfLoad[this.urls[r]]*=t:this.percentageOfLoad[this.urls[r]]=n}}_continueLoadQueue(){if(this.loadIdx<this.urls.length){const e=this.urls[this.loadIdx],t=this.loaders[e];this.status[e]=!1,this.loadIdx++,t.on("progress",this._onLoadProgress.bind(this,e)),t.once("error",this._onLoadError.bind(this,e)),t.once("complete",this._onLoadComplete.bind(this,e)),t.load(e)}else this._checkComplete()&&this.emit("complete")}_onLoadError(e,t){console.warn(`Couldn't load ${e}, received the error: ${t}`);const i=this.percentageOfLoad[e];this.emit("progress",this.percTotal+i,e),this.status[e]=!0,this._continueLoadQueue()}_onLoadProgress(e,t){const i=this.percentageOfLoad[e]*t;this.emit("progress",this.percTotal+i,e)}_onLoadComplete(e,t){this.percTotal+=this.percentageOfLoad[e],this.status[e]=!0,this._continueLoadQueue()}_checkComplete(){let e=!0;for(let t=0,i=this.urls.length;t<i;t++)this.status[this.urls[t]]||(e=!1);return e}_getLoader(e){const t=w(e);let i=S;return t&&A[t.toLowerCase()]&&(i=A[t.toLowerCase()]),i}}return g});
